// Prisma schema for TC Warranty Form

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Submission {
  id                  String     @id @default(uuid())
  timestamp           DateTime   @default(now())
  vorname             String
  nachname            String
  strasseHausnummer   String
  plz                 String
  ort                 String
  tcNummer            String
  email               String
  telefon             String
  beschreibung        String     @db.Text
  haustyp             String?
  bauleitungId        String?
  abnahme             String?
  verantwortlicherId  String?
  gewerkId            String?
  firmaId             String?
  dsgvoAccepted       Boolean    @default(true)
  status              Status     @default(OFFEN)
  ersteFrist          DateTime?
  zweiteFrist         DateTime?
  erledigtAm          DateTime?
  trackingToken       String?    @unique  // Cryptographic token for secure tracking link
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  files               File[]
  customer            Customer?
  bauleitung          Bauleitung? @relation(fields: [bauleitungId], references: [id])
  verantwortlicher    Verantwortlicher? @relation(fields: [verantwortlicherId], references: [id])
  gewerk              Gewerk? @relation(fields: [gewerkId], references: [id])
  firma               Firma? @relation(fields: [firmaId], references: [id])

  @@index([tcNummer])
  @@index([status])
  @@index([timestamp(sort: Desc)])
}

model File {
  id            String     @id @default(uuid())
  submissionId  String
  name          String
  type          String
  size          Int
  url           String
  uploadedAt    DateTime   @default(now())

  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}

enum Status {
  OFFEN
  IN_BEARBEITUNG
  ERLEDIGT
  MAGEL_ABGELEHNT
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  name          String?
  role          UserRole     @default(USER)
  supabaseId    String?      @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  activityLogs  ActivityLog[]

  @@index([email])
  @@index([role])
  @@index([supabaseId])
}

model ActivityLog {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action        String
  entityType    String
  entityId      String
  oldValue      String?  @db.Text
  newValue      String?  @db.Text
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt(sort: Desc)])
}

// Master data for dropdown options
model Bauleitung {
  id          String       @id @default(uuid())
  name        String       @unique
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[]

  @@index([active])
  @@map("_Bauleitung")
}

model Verantwortlicher {
  id          String       @id @default(uuid())
  name        String       @unique
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[]

  @@index([active])
  @@map("_Verantwortlicher")
}

model Gewerk {
  id          String       @id @default(uuid())
  name        String       @unique
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[]

  @@index([active])
  @@map("_Gewerk")
}

model Firma {
  id          String       @id @default(uuid())
  name        String       @unique
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[]

  @@index([active])
  @@map("_Firma")
}

enum UserRole {
  USER
  ADMIN
}

// Customer authentication for warranty tracking
model Customer {
  id            String     @id @default(uuid())
  submissionId  String     @unique
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  email         String
  tcNummer      String
  passwordHash  String
  createdAt     DateTime   @default(now())

  @@index([email])
  @@index([tcNummer])
  @@index([submissionId])
}

// Admin user management
model AdminUser {
  id                String      @id @default(uuid())
  username          String      @unique
  passwordHash      String
  role              AdminRole   @default(ADMIN)
  mustChangePassword Boolean    @default(false)
  createdAt         DateTime    @default(now())
  createdBy         String?

  @@index([username])
  @@index([role])
}

enum AdminRole {
  ADMIN
  STAFF
}
